<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio Player Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
        }
        .container {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 10px;
        }
        .status {
            margin: 20px 0;
            padding: 10px;
            background: white;
            border-radius: 5px;
        }
        button {
            margin: 5px;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
        }
        .error {
            color: red;
        }
        .success {
            color: green;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Audio Player Test</h1>
        
        <div class="status">
            <h3>Test Status:</h3>
            <div id="status-text">Ready to test...</div>
        </div>

        <div>
            <button onclick="testTTS()">Test TTS Generation</button>
            <button onclick="testAudioPlayback()">Test Audio Playback</button>
            <button onclick="clearCache()">Clear Cache</button>
        </div>

        <audio id="testAudio" controls style="width: 100%; margin-top: 20px;"></audio>

        <div id="log" style="margin-top: 20px; padding: 10px; background: white; border-radius: 5px; font-family: monospace; font-size: 12px; max-height: 300px; overflow-y: auto;"></div>
    </div>

    <script>
        const log = (message, type = 'info') => {
            const logEl = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? 'red' : type === 'success' ? 'green' : 'black';
            logEl.innerHTML += `<div style="color: ${color}">[${timestamp}] ${message}</div>`;
            logEl.scrollTop = logEl.scrollHeight;
        };

        const updateStatus = (message, type = 'info') => {
            const statusEl = document.getElementById('status-text');
            statusEl.className = type;
            statusEl.textContent = message;
        };

        async function testTTS() {
            try {
                updateStatus('Testing TTS generation...', 'info');
                log('Starting TTS test...');

                const testText = "This is a test of the audio generation system. If you can hear this message, the audio player is working correctly.";
                
                // Test with Supabase Edge Function
                const SUPABASE_URL = 'https://qjeavwwdqpoahzuvqniz.supabase.co';
                const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFqZWF2d3dkcXBvYWh6dXZxbml6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ5MzM2MjcsImV4cCI6MjA3MDUwOTYyN30.YpiidGS6hsHGfgEFY1NaBF1tKHgUdC-DMOOKhzw_9MA';
                
                const response = await fetch(`${SUPABASE_URL}/functions/v1/tts-stream`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        text: testText,
                        voice: 'sage',
                        speed: 1.0
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const blob = await response.blob();
                const audioUrl = URL.createObjectURL(blob);
                
                const audioElement = document.getElementById('testAudio');
                audioElement.src = audioUrl;
                
                log('TTS generation successful!', 'success');
                updateStatus('TTS test completed successfully!', 'success');
                
                // Auto-play
                audioElement.play().catch(e => {
                    log('Auto-play blocked: ' + e.message, 'error');
                });

            } catch (error) {
                log('TTS test failed: ' + error.message, 'error');
                updateStatus('TTS test failed: ' + error.message, 'error');
            }
        }

        async function testAudioPlayback() {
            try {
                updateStatus('Testing audio playback...', 'info');
                log('Starting audio playback test...');

                // Test with a simple audio file
                const audioElement = document.getElementById('testAudio');
                
                // Create a simple tone for testing
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = 440; // A4 note
                gainNode.gain.value = 0.3;
                
                oscillator.start();
                setTimeout(() => {
                    oscillator.stop();
                    log('Test tone played successfully', 'success');
                    updateStatus('Audio playback test completed!', 'success');
                }, 1000);

            } catch (error) {
                log('Audio playback test failed: ' + error.message, 'error');
                updateStatus('Audio test failed: ' + error.message, 'error');
            }
        }

        function clearCache() {
            const audioElement = document.getElementById('testAudio');
            audioElement.src = '';
            log('Cache cleared', 'success');
            updateStatus('Cache cleared', 'success');
        }

        // Initialize
        log('Audio test page loaded');
    </script>
</body>
</html>
